<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>숫자 4자리 랜덤 생성기!</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      button {
        padding: 10px 16px;
        font-size: 16px;
      }
      .num {
        font-size: 28px;
        margin-top: 12px;
        font-weight: bold;
      }
      .small {
        color: #666;
        margin-top: 8px;
      }
      .used-list {
        margin-top: 12px;
        max-height: 120px;
        overflow: auto;
        border: 1px solid #ddd;
        padding: 8px;
        background: #fafafa;
      }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  </head>
  <body>
    <h2>숫자 4자리 랜덤 생성기</h2>
          <p>
            1000~8000 사이의 숫자 중, 중복되는 숫자(예: 4402, 3131)나 연속되는 숫자(예: 1245, 5689)를 포함하지 않는 번호를 생성합니다.
          </p>

    <button id="generateBtn">번호 생성</button>
    <div class="num" id="result">-</div>
    <div class="small">상태: <span id="status">대기</span></div>

    <h4>이미 뽑힌 번호 (localStorage)</h4>
    <div class="used-list" id="usedList"></div>

    <button id="clearBtn" style="margin-top: 10px">저장된 번호 초기화</button>

        <script>

          (() => {

            // Your web app's Firebase configuration

            const firebaseConfig = {

              apiKey: "AIzaSyCljVnvtXQgCLW3ZXg6jAmRFTsBGGXYAWk",

              authDomain: "mytoy-d40ac.firebaseapp.com",

              projectId: "mytoy-d40ac",

              storageBucket: "mytoy-d40ac.firebasestorage.app",

              messagingSenderId: "17110972157",

              appId: "1:17110972157:web:7519854280d49f0e8db094"

            };

    

            // Initialize Firebase

            firebase.initializeApp(firebaseConfig);

            const db = firebase.firestore();

            const numbersCollection = db.collection("usedNumbers");

    

    

            // UI Elements

            const resultEl = document.getElementById("result");

            const statusEl = document.getElementById("status");

            const usedListEl = document.getElementById("usedList");

            const generateBtn = document.getElementById("generateBtn");

            const clearBtn = document.getElementById("clearBtn");

    

    

            // Load used numbers from Firestore

            async function loadUsedSet() {

              try {

                const snapshot = await numbersCollection.get();

                const usedNumbers = snapshot.docs.map(doc => doc.id);

                return new Set(usedNumbers);

              } catch (e) {

                console.error("loadUsedSet error", e);

                statusEl.textContent = `DB 로딩 오류: ${e.message}`;

                return new Set();

              }

            }

    

            // Rule check: true if excluded

            function isExcluded(numStr) {

              if (numStr.length !== 4) return true;

              const digits = numStr.split('').map((d) => parseInt(d, 10));

              const uniqueDigits = new Set(digits);

              if (uniqueDigits.size < 4) return true;

              const sortedDigits = [...digits].sort((a, b) => a - b);

              for (let i = 0; i < sortedDigits.length - 1; i++) {

                if (sortedDigits[i + 1] === sortedDigits[i] + 1) return true;

              }

              return false;

            }

    

            // Generate a unique number

            async function generateUniqueLast4() {

              statusEl.textContent = "DB에서 번호 목록 로딩 중...";

              const used = await loadUsedSet();

              statusEl.textContent = "조건에 맞는 번호 탐색 중...";

    

              const MAX_RANDOM_TRIES = 2000;

              let tries = 0;

    

              while (tries < MAX_RANDOM_TRIES) {

                const n = Math.floor(Math.random() * 7001) + 1000; // 1000 ~ 8000

                const s = String(n);

                if (isExcluded(s) || used.has(s)) {

                  tries++;

                  continue;

                }

                // Found a number

                await numbersCollection.doc(s).set({});

                used.add(s);

                return { number: s, usedCount: used.size, exhausted: false };

              }

    

              // Fallback to linear scan if random tries fail

              statusEl.textContent = "랜덤 탐색 실패. 전체 스캔 중...";

              for (let n = 1000; n <= 8000; n++) {

                const s = String(n);

                if (isExcluded(s) || used.has(s)) continue;

                // Found a number

                await numbersCollection.doc(s).set({});

                used.add(s);

                return { number: s, usedCount: used.size, exhausted: false };

              }

    

              return { number: null, usedCount: used.size, exhausted: true };

            }

    

            // Refresh the displayed list of used numbers

            async function refreshUsedList() {

                statusEl.textContent = "DB에서 번호 목록 로딩 중...";

                const used = Array.from(await loadUsedSet()).sort();

                usedListEl.innerHTML = used.length ? used.join(", ") : "<i>없음</i>";

                statusEl.textContent = `대기 (DB에 ${used.length}개 저장됨)`;

            }

    

            // Event Listeners

            generateBtn.addEventListener("click", async () => {

              generateBtn.disabled = true;

              clearBtn.disabled = true;

              resultEl.textContent = "-";

              

              const res = await generateUniqueLast4();

              

              if (res.exhausted) {

                resultEl.textContent = "-";

                statusEl.textContent = `사용 가능한 번호 모두 소진됨 (DB에 ${res.usedCount}개 저장됨)`;

              } else {

                resultEl.textContent = res.number;

                statusEl.textContent = `생성 완료! (DB에 ${res.usedCount}개 저장됨)`;

              }

              await refreshUsedList();

              generateBtn.disabled = false;

              clearBtn.disabled = false;

            });

    

            clearBtn.addEventListener("click", async () => {

              if (confirm("DB에 저장된 모든 번호를 영구적으로 삭제하시겠습니까?")) {

                generateBtn.disabled = true;

                clearBtn.disabled = true;

                statusEl.textContent = "DB에서 모든 번호 삭제 중...";

                try {

                  const snapshot = await numbersCollection.get();

                  if (snapshot.empty) {

                     statusEl.textContent = "삭제할 번호가 없습니다.";

                  } else {

                    const batch = db.batch();

                    snapshot.docs.forEach(doc => batch.delete(doc.ref));

                    await batch.commit();

                    statusEl.textContent = "DB 초기화 완료";

                  }

                  resultEl.textContent = "-";

                  await refreshUsedList();

                } catch (e) {
                  console.error("Clear error", e);
                  statusEl.textContent = `초기화 오류: ${e.message}`;
                }
                generateBtn.disabled = false;
                clearBtn.disabled = false;
              }
            });
            // Initial load
            refreshUsedList();

          })();

        </script>
  </body>
</html>
